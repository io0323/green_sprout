name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Flutter SDK
      uses: actions/cache@v4
      id: flutter-cache
      with:
        path: ${{ runner.temp }}/flutter-sdk
        key: flutter-sdk-3.24.5-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          flutter-sdk-3.24.5-${{ runner.os }}-
    
    - name: Download and install Flutter (resumable + retry)
      id: flutter-setup
      run: |
        set -euo pipefail
        FLUTTER_VERSION=3.24.5
        FLUTTER_DIR="${RUNNER_TEMP:-/tmp}/flutter-sdk"
        mkdir -p "$FLUTTER_DIR"
        cd "$FLUTTER_DIR"
        ARCHIVE="flutter_linux_${FLUTTER_VERSION}-stable.tar.xz"
        URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/$ARCHIVE"
        
        # If archive isn't present or is incomplete, download with retries and resume support
        if [ ! -f "$ARCHIVE" ] || [ ! -s "$ARCHIVE" ]; then
          echo "Downloading Flutter SDK..."
          curl --fail --location --retry 5 --retry-delay 5 --continue-at - --max-time 600 --output "$ARCHIVE" "$URL" || {
            echo "Download failed, removing partial file and retrying..."
            rm -f "$ARCHIVE"
            curl --fail --location --retry 5 --retry-delay 5 --max-time 600 --output "$ARCHIVE" "$URL"
          }
        else
          echo "Using cached Flutter SDK archive"
        fi
        
        # Extract only if the flutter/ folder is missing
        if [ ! -d "$FLUTTER_DIR/flutter" ]; then
          echo "Extracting Flutter SDK..."
          tar -xJf "$ARCHIVE" -C "$FLUTTER_DIR"
        else
          echo "Using cached Flutter SDK"
        fi
        
        # Add flutter to PATH for following steps
        echo "$FLUTTER_DIR/flutter/bin" >> $GITHUB_PATH
        echo "Flutter SDK installed successfully"
      timeout-minutes: 15
    
    - name: Cache pub packages
      uses: actions/cache@v4
      if: steps.flutter-setup.outcome == 'success'
      with:
        path: |
          ${{ env.HOME }}/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
    
    - name: Check Flutter version
      run: flutter --version
      if: steps.flutter-setup.outcome == 'success'
    
    - name: Install dependencies
      run: flutter pub get
      if: steps.flutter-setup.outcome == 'success'
      timeout-minutes: 10
    
    - name: Check code formatting
      run: dart format --set-exit-if-changed .
    
    - name: Analyze code
      run: flutter analyze --fatal-infos
    
    - name: Check for unused imports
      run: |
        # Check for unused imports in Dart files
        if dart analyze . | grep "Unused import"; then
          echo "Found unused imports"
          exit 1
        fi
    - name: Check for TODO comments (warning only)
      run: |
        if grep -r "TODO" lib/ --include="*.dart"; then
          echo "::warning file=lib::Found TODO comments (work-in-progress code is allowed, but should be tracked)"
        fi
    
    - name: Check for FIXME/HACK comments and print statements
      run: |
        # Check for FIXME/HACK comments
        if grep -r "FIXME\|HACK" lib/ --include="*.dart"; then
          echo "Found FIXME/HACK comments"
          exit 1
        fi
        # Find print statements not inside kDebugMode blocks and not commented out
        if grep -r "print(" lib/ --include="*.dart" | grep -v "//" | grep -v "kDebugMode" | grep -v "'print(" | grep -v '"print(' ; then
          echo "Found print statements in production code (not in kDebugMode or comments)"
          exit 1
        fi
    
    - name: Check for debug statements
      run: |
        if grep -r "debugPrint\|debugDump" lib/ --include="*.dart" \
           | grep -v "kDebugMode" \
           | grep -v "//" \
           | grep -v "'debugPrint(" \
           | grep -v '"debugPrint(' ; then
          echo "Found debug statements in production code"
          exit 1
        fi

  dependency-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Flutter SDK
      uses: actions/cache@v4
      id: flutter-cache
      with:
        path: ${{ runner.temp }}/flutter-sdk
        key: flutter-sdk-3.24.5-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          flutter-sdk-3.24.5-${{ runner.os }}-
    
    - name: Download and install Flutter (resumable + retry)
      id: flutter-setup
      run: |
        set -euo pipefail
        FLUTTER_VERSION=3.24.5
        FLUTTER_DIR="${RUNNER_TEMP:-/tmp}/flutter-sdk"
        mkdir -p "$FLUTTER_DIR"
        cd "$FLUTTER_DIR"
        ARCHIVE="flutter_linux_${FLUTTER_VERSION}-stable.tar.xz"
        URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/$ARCHIVE"
        
        # If archive isn't present or is incomplete, download with retries and resume support
        if [ ! -f "$ARCHIVE" ] || [ ! -s "$ARCHIVE" ]; then
          echo "Downloading Flutter SDK..."
          curl --fail --location --retry 5 --retry-delay 5 --continue-at - --max-time 600 --output "$ARCHIVE" "$URL" || {
            echo "Download failed, removing partial file and retrying..."
            rm -f "$ARCHIVE"
            curl --fail --location --retry 5 --retry-delay 5 --max-time 600 --output "$ARCHIVE" "$URL"
          }
        else
          echo "Using cached Flutter SDK archive"
        fi
        
        # Extract only if the flutter/ folder is missing
        if [ ! -d "$FLUTTER_DIR/flutter" ]; then
          echo "Extracting Flutter SDK..."
          tar -xJf "$ARCHIVE" -C "$FLUTTER_DIR"
        else
          echo "Using cached Flutter SDK"
        fi
        
        # Add flutter to PATH for following steps
        echo "$FLUTTER_DIR/flutter/bin" >> $GITHUB_PATH
        echo "Flutter SDK installed successfully"
      timeout-minutes: 15
    
    - name: Cache pub packages
      uses: actions/cache@v4
      if: steps.flutter-setup.outcome == 'success'
      with:
        path: |
          ${{ env.HOME }}/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
    
    - name: Install dependencies
      run: flutter pub get
      if: steps.flutter-setup.outcome == 'success'
      timeout-minutes: 10
    
    - name: Check for outdated dependencies
      run: flutter pub outdated
    
    - name: Check for security vulnerabilities
      run: flutter pub deps --style=compact
    
    - name: Verify pubspec.yaml
      run: |
        flutter pub deps
        flutter pub get --offline

  documentation-check:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Cache Flutter SDK
      uses: actions/cache@v4
      id: flutter-cache
      with:
        path: ${{ runner.temp }}/flutter-sdk
        key: flutter-sdk-3.24.5-${{ runner.os }}-${{ hashFiles('**/pubspec.yaml') }}
        restore-keys: |
          flutter-sdk-3.24.5-${{ runner.os }}-
    
    - name: Download and install Flutter (resumable + retry)
      id: flutter-setup
      run: |
        set -euo pipefail
        FLUTTER_VERSION=3.24.5
        FLUTTER_DIR="${RUNNER_TEMP:-/tmp}/flutter-sdk"
        mkdir -p "$FLUTTER_DIR"
        cd "$FLUTTER_DIR"
        ARCHIVE="flutter_linux_${FLUTTER_VERSION}-stable.tar.xz"
        URL="https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/$ARCHIVE"
        
        # If archive isn't present or is incomplete, download with retries and resume support
        if [ ! -f "$ARCHIVE" ] || [ ! -s "$ARCHIVE" ]; then
          echo "Downloading Flutter SDK..."
          curl --fail --location --retry 5 --retry-delay 5 --continue-at - --max-time 600 --output "$ARCHIVE" "$URL" || {
            echo "Download failed, removing partial file and retrying..."
            rm -f "$ARCHIVE"
            curl --fail --location --retry 5 --retry-delay 5 --max-time 600 --output "$ARCHIVE" "$URL"
          }
        else
          echo "Using cached Flutter SDK archive"
        fi
        
        # Extract only if the flutter/ folder is missing
        if [ ! -d "$FLUTTER_DIR/flutter" ]; then
          echo "Extracting Flutter SDK..."
          tar -xJf "$ARCHIVE" -C "$FLUTTER_DIR"
        else
          echo "Using cached Flutter SDK"
        fi
        
        # Add flutter to PATH for following steps
        echo "$FLUTTER_DIR/flutter/bin" >> $GITHUB_PATH
        echo "Flutter SDK installed successfully"
      timeout-minutes: 15
    
    - name: Cache pub packages
      uses: actions/cache@v4
      if: steps.flutter-setup.outcome == 'success'
      with:
        path: |
          ${{ env.HOME }}/.pub-cache
        key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          ${{ runner.os }}-pub-
    
    - name: Install dependencies
      run: flutter pub get
      if: steps.flutter-setup.outcome == 'success'
      timeout-minutes: 10
    
    - name: Check documentation
      run: |
        find lib -name "*.dart" -exec grep -L "///" {} \; | \
        grep -v "main.dart" | \
        grep -v "generated" | \
        head -10
    
    - name: Generate documentation
      run: |
        # lib/features/domain/entitiesが存在しない場合はスキップ
        if [ -d "lib/features/domain/entities" ]; then
          dart doc
        else
          echo "lib/features/domain/entities not found — skipping dart doc"
          # 通常のdart docを実行（エラーが発生しない場合）
          dart doc || echo "dart doc completed with warnings (non-critical)"
        fi
    
    - name: Check README
      run: |
        if [ ! -f README.md ]; then
          echo "README.md not found"
          exit 1
        fi
    
    - name: Check CHANGELOG
      run: |
        if [ ! -f CHANGELOG.md ]; then
          echo "CHANGELOG.md not found"
          exit 1
        fi
